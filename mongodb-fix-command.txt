// Run these commands in MongoDB Atlas Data Explorer or MongoDB Compass

// 1. First, check if there's a unique index on contactInfo.email
db.agencies.getIndexes()

// 2. If there is, drop the index
db.agencies.dropIndex("contactInfo.email_1")

// 3. Update all agencies to ensure contactInfo.email is set
db.agencies.updateMany(
  { $or: [
      { "contactInfo.email": null },
      { "contactInfo.email": { $exists: false } },
      { "contactInfo": null },
      { "contactInfo": { $exists: false } }
    ]
  },
  { $set: { 
      "contactInfo": {
        "email": "$gmail",
        "phone": "$phno"
      }
    } 
  }
)

// 4. Verify the changes
db.agencies.find({ "contactInfo.email": null }).count()
